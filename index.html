<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Jogadores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f3f4f6; --text-light: #1f2937; --card-light: #ffffff; --border-light: #e5e7eb;
            --bg-dark: #111827; --text-dark: #d1d5db; --card-dark: #1f2937; --border-dark: #374151;
        }
        html.light { --bg-color: var(--bg-light); --text-color: var(--text-light); --card-color: var(--card-light); --border-color: var(--border-light); }
        html.dark { --bg-color: var(--bg-dark); --text-color: var(--text-dark); --card-color: var(--card-dark); --border-color: var(--border-dark); }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .card { background-color: var(--card-color); border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        .modal { display: none; }
        .modal.show { display: flex; }
        .xp-bar-inner { transition: width 0.5s ease-in-out; }
        .trend-arrow.up { color: #22c55e; }
        .trend-arrow.down { color: #ef4444; }
        .trend-arrow.stable { color: #6b7280; }
        .mobile-mode #rankings-grid { gap: 0.75rem; }
        .mobile-mode .player-card { flex-direction: row; align-items: center; padding: 0.5rem; }
        .mobile-mode .player-card img { width: 32px; height: 32px; }
        .mobile-mode .player-card .player-info { margin-left: 0.75rem; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mobile-mode .player-card .player-info p { font-size: 0.875rem; }
        .mobile-mode .player-card > span:last-child { font-size: 0.875rem; min-width: 40px; text-align: right; }
        #mobile-mode-toggle:checked ~ .dot { transform: translateX(1rem); }
        #mobile-mode-toggle:checked ~ .block { background-color: #3b82f6; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .rarity-comum { border-color: #9ca3af; color: #9ca3af; }
        .rarity-raro { border-color: #3b82f6; color: #3b82f6; }
        .rarity-epico { border-color: #a855f7; color: #a855f7; }
        .rarity-lendario { border-color: #f59e0b; color: #f59e0b; }
        .rarity-mitico { border: 2px solid; border-image-slice: 1; border-image-source: linear-gradient(to right, #f59e0b, #ef4444, #ec4899); color: #f59e0b; }
        .notification-popup { position: fixed; top: 20px; right: 20px; z-index: 1000; transform: translateX(200%); transition: transform 0.5s ease-in-out; }
        .notification-popup.show { transform: translateX(0); }
        .badge-level { display: inline-block; padding: 0.25rem 0.75rem; font-size: 0.875rem; font-weight: 600; border-radius: 9999px; color: white; }
        .badge-level-lenda { background-color: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
        .badge-level-craque { background-color: #9ca3af; }
        .badge-level-diferenciado { background-color: #3b82f6; }
        .badge-level-esforcado { background-color: #10b981; }
        .badge-level-iniciante { background-color: #6b7280; }
        .status-vitoria { color: #22c55e; font-weight: bold; }
        .status-derrota { color: #ef4444; font-weight: bold; }
        .status-empate { color: #6b7280; font-weight: bold; }
    </style>
</head>
<body class="antialiased">
    
    <div id="loading" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <i class="fas fa-futbol fa-spin text-5xl text-blue-500"></i>
            <p class="text-white text-lg mt-4">Carregando dados...</p>
        </div>
    </div>

    <div id="app-container" class="container mx-auto p-4 md:p-6 hidden">
        <header class="flex flex-wrap justify-between items-center mb-6">
            <div class="flex items-center space-x-4">
                <img src="https://raw.githubusercontent.com/ittokki/Futebol/ba59ab86cf2095d4e9214bd5e24e21ac8aeaf33a/inimigos%20da%20bola.jpg" alt="Logo Inimigos da Bola" class="w-12 h-12 object-contain rounded-md">
                <h1 class="text-3xl font-bold text-blue-500">Inimigos da Bola</h1>
            </div>
            <div class="flex items-center space-x-3 mt-4 sm:mt-0">
                <button id="update-data-button" class="px-3 py-2 text-sm font-medium card rounded-md hover:bg-blue-500 hover:text-white transition-colors"><i class="fas fa-sync-alt mr-2"></i>Atualizar</button>
                <label for="mobile-mode-toggle" class="flex items-center cursor-pointer text-sm">
                    <span class="mr-2">Mobile</span>
                    <div class="relative">
                        <input type="checkbox" id="mobile-mode-toggle" class="sr-only">
                        <div class="block bg-gray-600 w-10 h-6 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                    </div>
                </label>
                <button id="theme-toggle" class="w-10 h-10 card rounded-full flex items-center justify-center text-xl">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </header>

        <nav class="mb-6">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <div class="flex -mb-px space-x-2 sm:space-x-6" id="tabs">
                    <button data-tab="rankings" class="tab-button active text-sm sm:text-base whitespace-nowrap py-4 px-1 border-b-2 font-medium"><i class="fas fa-trophy mr-2"></i>Rankings</button>
                    <button data-tab="graficos" class="tab-button text-sm sm:text-base whitespace-nowrap py-4 px-1 border-b-2 font-medium"><i class="fas fa-chart-line mr-2"></i>Gráficos</button>
                    <button data-tab="hall-da-fama" class="tab-button text-sm sm:text-base whitespace-nowrap py-4 px-1 border-b-2 font-medium"><i class="fas fa-star mr-2"></i>Hall da Fama</button>
                    <button data-tab="partidas" class="tab-button text-sm sm:text-base whitespace-nowrap py-4 px-1 border-b-2 font-medium"><i class="fas fa-history mr-2"></i>Partidas</button>
                    <button data-tab="curiosidades" class="tab-button text-sm sm:text-base whitespace-nowrap py-4 px-1 border-b-2 font-medium"><i class="fas fa-lightbulb mr-2"></i>Curiosidades</button>
                    <button data-tab="admins" class="tab-button text-sm sm:text-base whitespace-nowrap py-4 px-1 border-b-2 font-medium"><i class="fas fa-shield-alt mr-2"></i>Admins</button>
                </div>
            </div>
        </nav>

        <main id="tab-content">
            <div id="rankings" class="tab-pane active">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <div class="relative w-full sm:w-64">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="player-search" placeholder="Buscar jogador..." class="w-full p-2 pl-10 rounded-md card focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="w-full sm:w-auto">
                        <label for="month-filter" class="sr-only">Filtrar por Mês</label>
                        <select id="month-filter" class="w-full p-2 rounded-md card"></select>
                    </div>
                </div>
                <div id="destaque-mes-container" class="mb-6"></div>
                <div id="rankings-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>
            <div id="graficos" class="tab-pane hidden"></div>
            <div id="hall-da-fama" class="tab-pane hidden">
                <div id="hall-of-fame-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            <div id="partidas" class="tab-pane hidden space-y-6"></div>
            <div id="admins" class="tab-pane hidden"></div>
            <div id="curiosidades" class="tab-pane hidden">
                <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-bold">Fatos Curiosos</h2>
                     <button id="new-facts-button" class="px-4 py-2 text-sm font-medium card rounded-md hover:bg-blue-500 hover:text-white transition-colors">
                         <i class="fas fa-sync-alt mr-2"></i>Gerar Novas
                     </button>
                </div>
                <div id="curiosidades-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </main>
    </div>

    <div id="main-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-40">
        <div id="modal-container" class="card rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto relative animate-scale-in">
            <button id="modal-close-button" class="absolute top-4 right-4 text-2xl hover:text-red-500 transition-colors z-10">&times;</button>
            <div id="modal-content" class="p-6"></div>
        </div>
    </div>
    
<script>
const DashboardApp = (() => {
    'use strict';

    const config = {
        apiKey: "AIzaSyCL19ds6YqVOv5vV-zygBjeC-byy-rDPfM",
        spreadsheetId: "1TvrVT8ksYYMlpw8gkKIFvpnnCf02J8uYTkhHc5c0vdo",
        rangePagina1: "Página1!A2:H100",
        rangePagina2: "Página2!A2:K300",
        cacheDuration: 3600 * 1000,
        playerPhotos: { "HENRIQUE AMARAL": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Henrique.jpg", "VITOR": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Vitor%20gol.jpg", "MARCO DAITX": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Marco.jpg", "EDUARDO DUDU": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Eduardo.jpg", "WILIAN SILVA": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Wiliam%20Silva.jpg", "DOUGLAS DAITX": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Douglas.jpg", "GUSTAVO": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Gustavo.jpg", "ADEMIR": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Ademir.jpg", "DAVI": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Davi%20Mattos.jpg", "VICTOR MATHEUS": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Victor%20Matheus.jpg", "ANDRE": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/main/Andre.jpg", "MAICON": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Maicon.jpg", "CRISTIANO": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Cristiano.jpg", "CLAUDIO SCHNEIRDER": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Claudio.jpg", "WILIAN": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/main/Wiliam.jpg", "IAGO NUNES": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Iago%20Nunes.jpg", "WILLY": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/WILLY.jpg", "ZECA": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/ZECA.jpg", "FRANCISCO CHICO": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/FRANCISCO%20CHICO.jpg", "PEDRALLI": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/PEDRALLI.jpg", "THALES RAMOS": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Thales%20Ramos.jpg", "BRUNO GUIMARAES": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Bruno.jpg", "EVERTON": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Everton.jpg", "JUAREZ CARDOSO": "https://github.com/ittokki/Fotos-jogadores/blob/main/juarez.jpg?raw=true", "CARLOS ALEXANDRE": "https://raw.githubusercontent.com/ittokki/Fotos-jogadores/refs/heads/main/Carlos%20alexandre.jpg" },
        levelBorderColors: { 'Lenda': '#f59e0b', 'Craque': '#9ca3af', 'Diferenciado': '#3b82f6', 'Esforçado': '#10b981', 'Iniciante': '#6b7280' },
        sounds: { click: new Audio('https://raw.githubusercontent.com/ittokki/Futebol/5cc70b08d51f09dae0341672e52b2a435a276c05/PES%202013%20Select%20Game%20Main%20Menu%20Sound%20Effect%20(mp3cut.net).mp3') }
    };

    const state = {
        allPlayers: [],
        allMatches: [],
        chartInstances: {},
        userInteracted: false,
    };

    const DOMElements = {
        loading: document.getElementById('loading'),
        appContainer: document.getElementById('app-container'),
        tabs: document.getElementById('tabs'),
        tabContent: document.getElementById('tab-content'),
        rankingsGrid: document.getElementById('rankings-grid'),
        monthFilter: document.getElementById('month-filter'),
        playerSearch: document.getElementById('player-search'),
        destaqueMesContainer: document.getElementById('destaque-mes-container'),
        hallOfFameContainer: document.getElementById('hall-of-fame-container'),
        partidasContainer: document.getElementById('partidas'),
        curiosidadesContainer: document.getElementById('curiosidades-container'),
        mainModal: document.getElementById('main-modal'),
        modalContainer: document.getElementById('modal-container'),
        modalContent: document.getElementById('modal-content'),
        modalCloseBtn: document.getElementById('modal-close-button'),
        themeToggle: document.getElementById('theme-toggle'),
        mobileModeToggle: document.getElementById('mobile-mode-toggle'),
    };

    const utils = {
        parseNum: val => {
            if (typeof val === "number") return val;
            if (!val) return 0;
            return Number(String(val).replace(',', '.').trim()) || 0;
        },
        normalizeName: name => {
            if (!name || typeof name !== 'string') return '';
            return name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, " ").replace(/\(GOL\)/gi, "").trim().toUpperCase();
        },
        formatValue: (value, type) => {
            const formatters = {
                'aproveitamento': () => value.toFixed(0),
                'mediaGolsSofridos': () => value.toFixed(2),
                'notaGeral': () => value.toFixed(1),
            };
            return formatters[type] ? formatters[type]() : Math.round(value);
        },
        getStandardDeviation: array => {
            const n = array.length;
            if (n < 2) return 0;
            const mean = array.reduce((a, b) => a + b) / n;
            return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n);
        }
    };

    const api = {
        fetchSheetData: async (range) => {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}/values/${range}?key=${config.apiKey}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Erro ao buscar dados: ${response.statusText}`);
            const data = await response.json();
            return data.values || [];
        },
        fetchAllData: async () => {
            const now = Date.now();
            const partidasCacheTime = localStorage.getItem('partidasCacheTime');
            const jogadoresCacheTime = localStorage.getItem('jogadoresCacheTime');

            if (partidasCacheTime && jogadoresCacheTime && (now - partidasCacheTime < config.cacheDuration) && (now - jogadoresCacheTime < config.cacheDuration)) {
                console.log("Carregando dados do cache.");
                const partidas = JSON.parse(localStorage.getItem('partidasCache'));
                const jogadores = JSON.parse(localStorage.getItem('jogadoresCache'));
                if (partidas && jogadores) return { partidas, jogadores };
            }

            console.log("Buscando dados da API.");
            const [partidas, jogadores] = await Promise.all([api.fetchSheetData(config.rangePagina2), api.fetchSheetData(config.rangePagina1)]);
            localStorage.setItem('partidasCache', JSON.stringify(partidas));
            localStorage.setItem('partidasCacheTime', now);
            localStorage.setItem('jogadoresCache', JSON.stringify(jogadores));
            localStorage.setItem('jogadoresCacheTime', now);
            return { partidas, jogadores };
        }
    };

    const logic = {
        calculateMatchScore: (dados) => {
            const PESOS = { ADM: 5, GOLS: 0.7, ASSIST: 0.6, GOLS_TOMADOS: dados.isGoleiro ? -0.15 : 0, GOLS_CONTRA: -0.7 };
            const vitoriaValor = dados.vitoria === 1 ? 0.3 : dados.vitoria === 0.5 ? 0.15 : 0;
            const notaTecnica = 6.0 + (dados.gols * PESOS.GOLS) + (dados.assistencias * PESOS.ASSIST) + (dados.golsTomados * PESOS.GOLS_TOMADOS) + (dados.golsContra * PESOS.GOLS_CONTRA) + vitoriaValor;
            let notaFinal = (notaTecnica + (dados.notaADM * PESOS.ADM)) / (1 + PESOS.ADM);
            return Math.max(0, Math.min(10, Math.round(notaFinal * 10) / 10));
        },
        processData: (partidasRaw, jogadoresRaw) => {
            const jogadoresMap = new Map(jogadoresRaw.map(row => [utils.normalizeName(row[1]), { id: row[0], nome: utils.normalizeName(row[1]), nomeOriginal: row[1] }]));
            
            const matches = partidasRaw.map(row => {
                const isGoleiro = (row[0] || "").toUpperCase().includes('(GOL)') || utils.parseNum(row[3]) > 0;
                const vitoriaStatus = (row[7] || "").toLowerCase().trim();
                const matchData = {
                    nome: utils.normalizeName(row[0]), nomeRaw: row[0], gols: utils.parseNum(row[1]), assistencias: utils.parseNum(row[2]),
                    golsTomados: utils.parseNum(row[3]), golsContra: utils.parseNum(row[4]), notaADM: utils.parseNum(row[5]),
                    dataJogo: row[6], vitoria: vitoriaStatus === 'sim' ? 1 : vitoriaStatus === 'empate' ? 0.5 : 0,
                    time: row[8] || 'N/A', jogoAconteceu: (row[10] || "").toLowerCase() === 'sim', isGoleiro
                };
                matchData.notaPartida = matchData.jogoAconteceu ? logic.calculateMatchScore(matchData) : 0;
                return matchData;
            }).filter(p => p.nome && /^\d{2}\/\d{2}\/\d{4}$/.test(p.dataJogo));

            const players = logic.recalculateStatsForPeriod(Array.from(jogadoresMap.values()), matches);
            return { players, matches };
        },
        recalculateStatsForPeriod: (basePlayers, periodMatches) => {
            const playersMap = new Map();
            basePlayers.forEach(p => playersMap.set(p.nome, { ...p, jogos: 0, vitorias: 0, empates: 0, gols: 0, assistencias: 0, golsContra: 0, golsTomados: 0, partidas: [], notasGeral: [], notasGoleiro: [], notasLinha: [] }));

            periodMatches.filter(p => p.jogoAconteceu).forEach(p => {
                if (!playersMap.has(p.nome)) return;
                const j = playersMap.get(p.nome);
                j.jogos++;
                if (p.vitoria === 1) j.vitorias++;
                if (p.vitoria === 0.5) j.empates++;
                j.gols += p.gols;
                j.assistencias += p.assistencias;
                j.golsContra += p.golsContra;
                j.golsTomados += p.golsTomados;
                j.partidas.push(p);
                j.notasGeral.push(p.notaPartida);
                if (p.isGoleiro) j.notasGoleiro.push(p.notaPartida); else j.notasLinha.push(p.notaPartida);
            });
            
            const playersWithGames = Array.from(playersMap.values()).filter(p => p.jogos > 0);
            playersWithGames.forEach(j => {
                j.aproveitamento = j.jogos > 0 ? ((j.vitorias + j.empates * 0.5) / j.jogos) * 100 : 0;
                j.notaGeral = j.notasGeral.length ? j.notasGeral.reduce((a, b) => a + b, 0) / j.notasGeral.length : 0;
                // Simplified MVP calculation for brevity; the original logic can be ported here
                j._pontosBrutos = (j.gols * 2) + j.assistencias + j.vitorias - (j.golsContra * 0.5) + (j.notaGeral * 10);
            });
            
            const maxPontos = Math.max(...playersWithGames.map(j => j._pontosBrutos || 0));
            playersWithGames.forEach(j => {
                j.pontosMVP = maxPontos > 0 ? Math.round((j._pontosBrutos / maxPontos) * 100) : 0;
                j.nivel = j.pontosMVP >= 90 ? 'Lenda' : j.pontosMVP >= 70 ? 'Craque' : j.pontosMVP >= 50 ? 'Diferenciado' : j.pontosMVP >= 20 ? 'Esforçado' : 'Iniciante';
            });

            return playersWithGames;
        },
        generateFunFacts: (players, matches) => {
            const factFunctions = [
                // Fatos sobre artilharia e vitórias
                (p, m) => { const best = p.sort((a,b)=>b.gols-a.gols)[0]; return best ? {icon:'⚽', text:`O maior artilheiro geral é <b>${best.nomeOriginal}</b> com <b>${best.gols}</b> gols.`} : null; },
                (p, m) => { const best = p.sort((a,b)=>b.vitorias-a.vitorias)[0]; return best ? {icon:'🏆', text:`O jogador mais vitorioso é <b>${best.nomeOriginal}</b>, com <b>${best.vitorias}</b> vitórias.`} : null; },
                (p, m) => {
                    const bestMatch = m.filter(match => match.jogoAconteceu).sort((a,b) => b.notaPartida - a.notaPartida)[0];
                    if(!bestMatch) return null;
                    const player = p.find(pl => pl.nome === bestMatch.nome);
                    return { icon: '⭐', text: `A maior nota já registrada foi <b>${bestMatch.notaPartida.toFixed(1)}</b>, por <b>${player?.nomeOriginal || bestMatch.nome}</b> em ${bestMatch.dataJogo}.`};
                },
                // NOVAS CURIOSIDADES INCLUSIVAS
                (p, m) => { // De Olho no Marco
                    const milestones = [{key: 'gols', value: 25}, {key: 'jogos', value: 50}, {key: 'vitorias', value: 15}];
                    let closestPlayer = null;
                    let minDiff = Infinity;

                    p.forEach(player => {
                        milestones.forEach(milestone => {
                            const diff = milestone.value - player[milestone.key];
                            if(diff > 0 && diff < minDiff && diff <= 5) {
                                minDiff = diff;
                                closestPlayer = { ...player, diff, milestone };
                            }
                        });
                    });
                    if(!closestPlayer) return null;
                    return { icon: '🎯', text: `<b>De olho no marco!</b> ${closestPlayer.nomeOriginal} está a apenas <b>${closestPlayer.diff}</b> ${closestPlayer.milestone.key} de atingir a marca de <b>${closestPlayer.milestone.value}</b>.` };
                },
                (p, m) => { // Maior Rivalidade
                    const rivalries = {};
                    const matchesByDate = m.reduce((acc, match) => { (acc[match.dataJogo] = acc[match.dataJogo] || []).push(match); return acc; }, {});
                    
                    for(const date in matchesByDate) {
                        const boca = matchesByDate[date].filter(match => match.time.toUpperCase() === 'BOCA').map(m => m.nome);
                        const river = matchesByDate[date].filter(match => match.time.toUpperCase() === 'RIVER').map(m => m.nome);
                        if (boca.length === 0 || river.length === 0) continue;
                        boca.forEach(p1 => river.forEach(p2 => {
                            const pair = [p1, p2].sort().join('-');
                            rivalries[pair] = (rivalries[pair] || 0) + 1;
                        }));
                    }
                    const topRivalry = Object.entries(rivalries).sort((a,b)=>b[1]-a[1])[0];
                    if(!topRivalry || topRivalry[1] < 3) return null;
                    const [p1Name, p2Name] = topRivalry[0].split('-');
                    const player1 = p.find(pl => pl.nome === p1Name)?.nomeOriginal || p1Name;
                    const player2 = p.find(pl => pl.nome === p2Name)?.nomeOriginal || p2Name;

                    return { icon: '⚔️', text: `<b>A maior rivalidade</b> é entre <b>${player1}</b> e <b>${player2}</b>, que se enfrentaram em times opostos <b>${topRivalry[1]}</b> vezes.` };
                },
                 (p, m) => { // Dupla Mais Entrosada
                    const duos = {};
                    const matchesByDate = m.reduce((acc, match) => { (acc[match.dataJogo] = acc[match.dataJogo] || []).push(match); return acc; }, {});

                    for(const date in matchesByDate) {
                        const teams = {
                            BOCA: matchesByDate[date].filter(match => match.time.toUpperCase() === 'BOCA').map(m => m.nome),
                            RIVER: matchesByDate[date].filter(match => match.time.toUpperCase() === 'RIVER').map(m => m.nome)
                        };
                        for (const team in teams) {
                            for(let i=0; i < teams[team].length; i++) {
                                for(let j=i+1; j < teams[team].length; j++) {
                                    const pair = [teams[team][i], teams[team][j]].sort().join('-');
                                    duos[pair] = (duos[pair] || 0) + 1;
                                }
                            }
                        }
                    }
                    const topDuo = Object.entries(duos).sort((a,b)=>b[1]-a[1])[0];
                    if(!topDuo || topDuo[1] < 5) return null;
                    const [p1Name, p2Name] = topDuo[0].split('-');
                    const player1 = p.find(pl => pl.nome === p1Name)?.nomeOriginal || p1Name;
                    const player2 = p.find(pl => pl.nome === p2Name)?.nomeOriginal || p2Name;

                    return { icon: '🤝', text: `<b>A dupla mais entrosada</b> é <b>${player1}</b> e <b>${player2}</b>, que jogaram juntos no mesmo time <b>${topDuo[1]}</b> vezes.` };
                }
            ];
            
            const shuffled = factFunctions.sort(() => 0.5 - Math.random());
            const selectedFacts = [];
            for (const func of shuffled) {
                if (selectedFacts.length >= 3) break;
                const fact = func(players, matches);
                if (fact) selectedFacts.push(fact);
            }
            return selectedFacts;
        }
    };
    
    const ui = {
        renderRankings: (players) => {
            DOMElements.rankingsGrid.innerHTML = '';
            const cards = [
                { title: 'Pontos MVP', key: 'pontosMVP' }, { title: 'Gols', key: 'gols' },
                { title: 'Assistências', key: 'assistencias' }, { title: 'Vitórias', key: 'vitorias' }
            ];
            cards.forEach(card => DOMElements.rankingsGrid.innerHTML += ui.createRankingCard(card.title, players, card.key));
        },
        createRankingCard: (title, data, key) => {
            const sortedData = [...data].sort((a, b) => b[key] - a[key]).slice(0, 5);
            const playersHtml = sortedData.length ? sortedData.map((p, index) => {
                const photoUrl = config.playerPhotos[p.nome] || `https://ui-avatars.com/api/?name=${p.nome.replace(' ', '+')}&background=random`;
                return `
                <div class="player-card flex items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 p-2 rounded-md" data-player-name="${p.nomeOriginal}">
                    <span class="font-bold w-6">${index + 1}.</span>
                    <img src="${photoUrl}" class="w-10 h-10 rounded-full object-cover mr-3" onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${p.nome.replace(' ', '+')}&background=random';">
                    <div class="flex-grow player-info"><p class="font-semibold truncate leading-tight">${p.nomeOriginal}</p></div>
                    <span class="font-bold text-blue-500">${utils.formatValue(p[key], key)}</span>
                </div>`;
            }).join('') : `<p class="text-gray-500 text-sm h-full flex items-center justify-center">Nenhum jogador encontrado.</p>`;

            return `<div class="card p-4 rounded-lg flex flex-col fade-in"><h3 class="font-bold text-lg mb-4">${title}</h3><div class="flex-grow space-y-3">${playersHtml}</div></div>`;
        },
        renderCuriosidades: () => {
            const facts = logic.generateFunFacts(state.allPlayers, state.allMatches);
            DOMElements.curiosidadesContainer.innerHTML = facts.map(fact => `
                <div class="card p-4 rounded-lg flex flex-col items-center justify-center text-center fade-in">
                    <div class="text-3xl mb-3">${fact.icon}</div>
                    <p class="text-base">${fact.text}</p>
                </div>
            `).join('');
        },
        showPlayerModal: (playerName) => {
            const player = state.allPlayers.find(p => p.nomeOriginal === playerName);
            if (!player) return;
            
            const photoUrl = config.playerPhotos[player.nome] || `https://ui-avatars.com/api/?name=${player.nome.replace(' ', '+')}&background=random`;
            const getStatusClass = (vitoria) => vitoria === 1 ? 'status-vitoria' : vitoria === 0.5 ? 'status-empate' : 'status-derrota';
            const getStatusText = (vitoria) => vitoria === 1 ? 'Vitória' : vitoria === 0.5 ? 'Empate' : 'Derrota';
            
            const partidasHtml = player.partidas.filter(p => p.jogoAconteceu).slice(-5).reverse().map(p => `
                <div class="card p-3 rounded-md flex justify-between items-center text-sm">
                    <div>
                        <span class="font-semibold">${p.dataJogo}</span>
                        <span class="ml-2 ${getStatusClass(p.vitoria)}">${getStatusText(p.vitoria)}</span>
                    </div>
                    <div class="text-right">
                        <span>G: ${p.gols}, A: ${p.assistencias}</span>
                        <span class="ml-4 font-bold text-blue-500 w-8 inline-block">${p.notaPartida.toFixed(1)}</span>
                    </div>
                </div>
            `).join('') || '<p>Nenhuma partida registrada.</p>';
            
            DOMElements.modalContent.innerHTML = `
                <div class="flex flex-col md:flex-row items-center md:items-start mb-6">
                    <img src="${photoUrl}" class="w-32 h-32 rounded-full object-cover border-4 border-blue-500 mb-4 md:mb-0 md:mr-6" onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${player.nome.replace(' ', '+')}&background=random';">
                    <div class="flex-grow text-center md:text-left">
                        <h2 class="text-3xl font-bold">${player.nomeOriginal}</h2>
                        <span class="badge-level badge-level-${player.nivel.toLowerCase()}">${player.nivel}</span>
                        <div class="mt-4"><p class="text-sm font-medium">Pontos MVP (Geral)</p><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 mt-1"><div class="xp-bar-inner bg-gradient-to-r from-blue-400 to-blue-600 h-4 rounded-full" style="width: ${player.pontosMVP}%;"></div></div><p class="text-right text-sm font-bold mt-1">${player.pontosMVP} / 100</p></div>
                    </div>
                </div>
                <h4 class="font-bold text-lg mb-3">Últimas 5 Partidas</h4>
                <div class="space-y-2">${partidasHtml}</div>`;
                
            DOMElements.mainModal.classList.add('show');
            document.body.style.overflow = 'hidden';
        },
        renderInitialDashboard: () => {
            ui.setupFilters();
            ui.updateFilteredView();
            DOMElements.loading.style.display = 'none';
            DOMElements.appContainer.classList.remove('hidden');
        },
        updateFilteredView: () => {
            const selectedMonth = DOMElements.monthFilter.value;
            const searchTerm = DOMElements.playerSearch.value.toLowerCase();
            let playersForPeriod = selectedMonth === 'Geral'
                ? state.allPlayers
                : logic.recalculateStatsForPeriod(state.allPlayers, state.allMatches.filter(p => p.dataJogo.slice(3) === selectedMonth));
            
            if (searchTerm) {
                playersForPeriod = playersForPeriod.filter(p => p.nomeOriginal.toLowerCase().includes(searchTerm));
            }
            ui.renderRankings(playersForPeriod);
        },
        setupFilters: () => {
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const uniqueMonths = [...new Set(state.allMatches.map(p => p.dataJogo.slice(3)))].sort((a, b) => {
                const [ma, ya] = a.split('/'); const [mb, yb] = b.split('/');
                return new Date(yb, mb - 1) - new Date(ya, ma - 1);
            });
            DOMElements.monthFilter.innerHTML = '<option value="Geral">Geral</option>' + uniqueMonths.map(monthYear => {
                const [month, year] = monthYear.split('/');
                return `<option value="${monthYear}">${monthNames[parseInt(month, 10) - 1]} de ${year}</option>`;
            }).join('');
        },
        applyTheme: () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.className = savedTheme;
            DOMElements.themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        },
        applyMobileMode: () => {
            const mobileMode = localStorage.getItem('mobileMode') === 'true';
            DOMElements.mobileModeToggle.checked = mobileMode;
            DOMElements.appContainer.classList.toggle('mobile-mode', mobileMode);
        },
    };

    const handlers = {
        handleInteraction: () => {
            state.userInteracted = true;
            document.removeEventListener('click', handlers.handleInteraction, true);
            document.removeEventListener('keydown', handlers.handleInteraction, true);
        },
        playSound: (sound) => {
            if (state.userInteracted) {
                sound.currentTime = 0;
                sound.play().catch(() => {});
            }
        },
        handleTabClick: (e) => {
            const button = e.target.closest('button');
            if (!button || !button.dataset.tab) return;
            
            handlers.playSound(config.sounds.click);
            DOMElements.tabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            DOMElements.tabContent.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.getElementById(button.dataset.tab).classList.remove('hidden');

            if(button.dataset.tab === 'curiosidades') ui.renderCuriosidades();
        },
        handleGeneralClick: (e) => {
             if (e.target.closest('button, select, label, input[type="checkbox"]')) {
                handlers.playSound(config.sounds.click);
            }
            const playerCard = e.target.closest('[data-player-name]');
            if (playerCard) {
                ui.showPlayerModal(playerCard.dataset.playerName);
            }
        },
        toggleTheme: () => {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const newTheme = html.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            ui.applyTheme();
        },
        toggleMobileMode: (e) => {
            const isMobile = e.target.checked;
            localStorage.setItem('mobileMode', isMobile);
            ui.applyMobileMode();
        },
        closeModal: (e) => {
            if (e.target === DOMElements.mainModal || e.target === DOMElements.modalCloseBtn) {
                DOMElements.mainModal.classList.remove('show');
                document.body.style.overflow = '';
            }
        },
        clearCacheAndReload: () => {
            DOMElements.loading.style.display = 'flex';
            localStorage.removeItem('partidasCache');
            localStorage.removeItem('partidasCacheTime');
            localStorage.removeItem('jogadoresCache');
            localStorage.removeItem('jogadoresCacheTime');
            setTimeout(() => location.reload(), 250);
        }
    };

    const bindEvents = () => {
        document.addEventListener('click', handlers.handleInteraction, true);
        document.addEventListener('keydown', handlers.handleInteraction, true);
        DOMElements.tabs.addEventListener('click', handlers.handleTabClick);
        DOMElements.themeToggle.addEventListener('click', handlers.toggleTheme);
        DOMElements.mobileModeToggle.addEventListener('change', handlers.toggleMobileMode);
        DOMElements.monthFilter.addEventListener('change', ui.updateFilteredView);
        DOMElements.playerSearch.addEventListener('input', ui.updateFilteredView);
        DOMElements.mainModal.addEventListener('click', handlers.closeModal);
        DOMElements.modalCloseBtn.addEventListener('click', handlers.closeModal);
        document.body.addEventListener('click', handlers.handleGeneralClick);
        document.getElementById('update-data-button').addEventListener('click', handlers.clearCacheAndReload);
        document.getElementById('new-facts-button').addEventListener('click', ui.renderCuriosidades);
    };

    const init = async () => {
        ui.applyTheme();
        ui.applyMobileMode();
        bindEvents();

        try {
            const { partidas, jogadores } = await api.fetchAllData();
            const processed = logic.processData(partidas, jogadores);
            state.allPlayers = processed.players;
            state.allMatches = processed.matches;
            ui.renderInitialDashboard();
        } catch (error) {
            console.error("Falha ao inicializar o dashboard:", error);
            DOMElements.loading.style.display = 'none';
        }
    };

    return { init };
})();

document.addEventListener('DOMContentLoaded', DashboardApp.init);
</script>

</body>
</html>
